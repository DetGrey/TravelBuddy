Îe
yC:\Users\natha\OneDrive\Skrivebord\Kea-it-arkitektur\5. semester\TravelBuddy\src\Modules\TravelBuddy.Users\UserService.cs
	namespace 	
TravelBuddy
 
. 
Users 
{ 
public 

	interface 
IUserService !
{		 
Task

 
<

 
User

 
?

 
>

 
AuthenticateAsync

 %
(

% &
string

& ,
email

- 2
,

2 3
string

4 :
password

; C
)

C D
;

D E
Task 
< 
User 
? 
> 
RegisterAsync !
(! "
RegisterRequestDto" 4
request5 <
)< =
;= >
Task 
< 
( 
bool 
Success 
, 
string "
?" #
ErrorMessage$ 0
)0 1
>1 2

DeleteUser3 =
(= >
int> A
userIdB H
)H I
;I J
Task 
< 
UserDto 
? 
> 
GetUserByIdAsync '
(' (
int( +
userId, 2
)2 3
;3 4
Task 
< 
( 
bool 
Success 
, 
string "
?" #
ErrorMessage$ 0
)0 1
>1 2
ChangePasswordAsync3 F
(F G$
PasswordChangeRequestDtoG _
request` g
,g h
stringi o
emailp u
,u v
intw z
userId	{ Å
)
Å Ç
;
Ç É
Task 
< 
IEnumerable 
< 
UserDto  
>  !
>! "
GetAllUsersAsync# 3
(3 4
)4 5
;5 6
Task 
< 
IEnumerable 
< 
UserAuditDto %
>% &
>& '
GetUserAuditsAsync( :
(: ;
); <
;< =
} 
public 

class 
UserService 
: 
IUserService +
{ 
private 
readonly "
IUserRepositoryFactory /"
_userRepositoryFactory0 F
;F G
public 
UserService 
( "
IUserRepositoryFactory 1!
userRepositoryFactory2 G
)G H
{ 	"
_userRepositoryFactory "
=# $!
userRepositoryFactory% :
;: ;
} 	
private   
IUserRepository   
GetRepo    '
(  ' (
)  ( )
=>  * ,"
_userRepositoryFactory  - C
.  C D
GetUserRepository  D U
(  U V
)  V W
;  W X
public"" 
async"" 
Task"" 
<"" 
User"" 
?"" 
>""  
AuthenticateAsync""! 2
(""2 3
string""3 9
email"": ?
,""? @
string""A G
password""H P
)""P Q
{## 	
var$$ 
userRepository$$ 
=$$  
GetRepo$$! (
($$( )
)$$) *
;$$* +
var&& 
user&& 
=&& 
await&& 
userRepository&& +
.&&+ ,
GetByEmailAsync&&, ;
(&&; <
email&&< A
)&&A B
;&&B C
if'' 
('' 
user'' 
=='' 
null'' 
||'' 
user''  $
.''$ %
	IsDeleted''% .
)''. /
return''0 6
null''7 ;
;''; <
bool)) 
isValid)) 
=)) 
PasswordHasher)) )
.))) *
VerifyPassword))* 8
())8 9
password))9 A
,))A B
user))C G
.))G H
PasswordHash))H T
)))T U
;))U V
return** 
isValid** 
?** 
user** !
:**" #
null**$ (
;**( )
}++ 	
public-- 
async-- 
Task-- 
<-- 
User-- 
?-- 
>--  
RegisterAsync--! .
(--. /
RegisterRequestDto--/ A
request--B I
)--I J
{.. 	
var// 
userRepository// 
=//  
GetRepo//! (
(//( )
)//) *
;//* +
var11 
existing11 
=11 
await11  
userRepository11! /
.11/ 0
GetByEmailAsync110 ?
(11? @
request11@ G
.11G H
Email11H M
)11M N
;11N O
if22 
(22 
existing22 
!=22 
null22  
)22  !
return22" (
null22) -
;22- .
var44 
hashedPassword44 
=44  
PasswordHasher44! /
.44/ 0
HashPassword440 <
(44< =
request44= D
.44D E
Password44E M
)44M N
;44N O
var66 
newUser66 
=66 
new66 
User66 "
{77 
Name88 
=88 
request88 
.88 
Name88 #
,88# $
Email99 
=99 
request99 
.99  
Email99  %
,99% &
PasswordHash:: 
=:: 
hashedPassword:: -
,::- .
	Birthdate;; 
=;; 
request;; #
.;;# $
	Birthdate;;$ -
,;;- .
Role<< 
=<< 
$str<< 
}== 
;== 
await?? 
userRepository??  
.??  !
AddAsync??! )
(??) *
newUser??* 1
)??1 2
;??2 3
returnAA 
newUserAA 
;AA 
}BB 	
publicDD 
asyncDD 
TaskDD 
<DD 
(DD 
boolDD 
SuccessDD  '
,DD' (
stringDD) /
?DD/ 0
ErrorMessageDD1 =
)DD= >
>DD> ?

DeleteUserDD@ J
(DDJ K
intDDK N
userIdDDO U
)DDU V
{EE 	
varFF 
userRepositoryFF 
=FF  
GetRepoFF! (
(FF( )
)FF) *
;FF* +
varHH 
placeholderHH 
=HH 
$"HH  
$strHH  (
{HH( )
userIdHH) /
}HH/ 0
$strHH0 1
{HH1 2
DateTimeHH2 :
.HH: ;
UtcNowHH; A
:HHA B
$strHHB P
}HHP Q
"HHQ R
;HHR S
varII 
hashedPasswordII 
=II  
PasswordHasherII! /
.II/ 0
HashPasswordII0 <
(II< =
placeholderII= H
)IIH I
;III J
returnJJ 
awaitJJ 
userRepositoryJJ '
.JJ' (
DeleteAsyncJJ( 3
(JJ3 4
userIdJJ4 :
,JJ: ;
hashedPasswordJJ< J
)JJJ K
;JJK L
}KK 	
publicMM 
asyncMM 
TaskMM 
<MM 
(MM 
boolMM 
SuccessMM  '
,MM' (
stringMM) /
?MM/ 0
ErrorMessageMM1 =
)MM= >
>MM> ?
ChangePasswordAsyncMM@ S
(MMS T$
PasswordChangeRequestDtoMMT l
requestMMm t
,MMt u
stringMMv |
email	MM} Ç
,
MMÇ É
int
MMÑ á
userId
MMà é
)
MMé è
{NN 	
varOO 
userRepositoryOO 
=OO  
GetRepoOO! (
(OO( )
)OO) *
;OO* +
varQQ 
userQQ 
=QQ 
awaitQQ 
userRepositoryQQ +
.QQ+ ,
GetByEmailAsyncQQ, ;
(QQ; <
emailQQ< A
)QQA B
;QQB C
ifRR 
(RR 
userRR 
==RR 
nullRR 
||RR 
userRR  $
.RR$ %
	IsDeletedRR% .
)RR. /
returnRR0 6
(RR7 8
falseRR8 =
,RR= >
$strRR? ^
)RR^ _
;RR_ `
boolUU 
isValidUU 
=UU 
PasswordHasherUU )
.UU) *
VerifyPasswordUU* 8
(UU8 9
requestUU9 @
.UU@ A
OldPasswordUUA L
,UUL M
userUUN R
.UUR S
PasswordHashUUS _
)UU_ `
;UU` a
ifVV 
(VV 
!VV 
isValidVV 
)VV 
returnVV  
(VV! "
falseVV" '
,VV' (
$strVV) E
)VVE F
;VVF G
varXX 
hashedPasswordXX 
=XX  
PasswordHasherXX! /
.XX/ 0
HashPasswordXX0 <
(XX< =
requestXX= D
.XXD E
NewPasswordXXE P
)XXP Q
;XXQ R
awaitYY 
userRepositoryYY  
.YY  !
UpdatePasswordAsyncYY! 4
(YY4 5
userIdYY5 ;
,YY; <
hashedPasswordYY= K
)YYK L
;YYL M
return[[ 
([[ 
true[[ 
,[[ 
null[[ 
)[[ 
;[[  
}\\ 	
public]] 
async]] 
Task]] 
<]] 
UserDto]] !
?]]! "
>]]" #
GetUserByIdAsync]]$ 4
(]]4 5
int]]5 8
userId]]9 ?
)]]? @
{^^ 	
var__ 
userRepository__ 
=__  
GetRepo__! (
(__( )
)__) *
;__* +
var`` 
user`` 
=`` 
await`` 
userRepository`` +
.``+ ,
GetUserByIdAsync``, <
(``< =
userId``= C
)``C D
;``D E
ifaa 
(aa 
useraa 
==aa 
nullaa 
)aa 
returnaa $
nullaa% )
;aa) *
returnbb 
newbb 
UserDtobb 
(bb 
usercc 
.cc 
UserIdcc 
,cc 
userdd 
.dd 
Namedd 
,dd 
useree 
.ee 
Emailee 
,ee 
userff 
.ff 
	Birthdateff 
)gg 
;gg 
}hh 	
publicii 
asyncii 
Taskii 
<ii 
IEnumerableii %
<ii% &
UserDtoii& -
>ii- .
>ii. /
GetAllUsersAsyncii0 @
(ii@ A
)iiA B
{jj 	
varkk 
userRepositorykk 
=kk  
GetRepokk! (
(kk( )
)kk) *
;kk* +
varnn 
usersnn 
=nn 
awaitnn 
userRepositorynn ,
.nn, -
GetAllAsyncnn- 8
(nn8 9
)nn9 :
;nn: ;
returnss 
usersss 
.ss 
Selectss 
(ss  
uss  !
=>ss" $
newss% (
UserDtoss) 0
(ss0 1
utt 
.tt 
UserIdtt 
,tt 
uuu 
.uu 
Nameuu 
,uu 
uvv 
.vv 
Emailvv 
,vv 
uww 
.ww 
	Birthdateww 
)xx 
)xx 
.xx 
ToListxx 
(xx 
)xx 
;xx 
}yy 	
public|| 
async|| 
Task|| 
<|| 
IEnumerable|| %
<||% &
UserAuditDto||& 2
>||2 3
>||3 4
GetUserAuditsAsync||5 G
(||G H
)||H I
{}} 	
var~~ 
userRepository~~ 
=~~  
GetRepo~~! (
(~~( )
)~~) *
;~~* +
var 
results 
= 
await 
userRepository  .
.. /
GetUserAuditsAsync/ A
(A B
)B C
;C D
return
ÄÄ 
results
ÄÄ 
.
ÄÄ 
Select
ÄÄ !
(
ÄÄ! "
ua
ÄÄ" $
=>
ÄÄ% '
new
ÄÄ( +
UserAuditDto
ÄÄ, 8
(
ÄÄ8 9
ua
ÅÅ 
.
ÅÅ 
AuditId
ÅÅ 
,
ÅÅ 
ua
ÇÇ 
.
ÇÇ 
UserId
ÇÇ 
,
ÇÇ 
ua
ÉÉ 
.
ÉÉ 
Action
ÉÉ 
,
ÉÉ 
ua
ÑÑ 
.
ÑÑ 
FieldChanged
ÑÑ 
,
ÑÑ  
ua
ÖÖ 
.
ÖÖ 
OldValue
ÖÖ 
,
ÖÖ 
ua
ÜÜ 
.
ÜÜ 
NewValue
ÜÜ 
,
ÜÜ 
ua
áá 
.
áá 
	ChangedBy
áá 
,
áá 
ua
àà 
.
àà 
	Timestamp
àà 
)
ââ 
)
ââ 
.
ââ 
ToList
ââ 
(
ââ 
)
ââ 
;
ââ 
}
ää 	
}
ãã 
}åå Ñ
~C:\Users\natha\OneDrive\Skrivebord\Kea-it-arkitektur\5. semester\TravelBuddy\src\Modules\TravelBuddy.Users\Models\UserAudit.cs
	namespace 	
TravelBuddy
 
. 
Users 
. 
Models "
;" #
public 
partial 
class 
	UserAudit 
{ 
public 

int 
AuditId 
{ 
get 
; 
set !
;! "
}# $
public 

int 
UserId 
{ 
get 
; 
set  
;  !
}" #
public		 

string		 
Action		 
{		 
get		 
;		 
set		  #
;		# $
}		% &
=		' (
null		) -
!		- .
;		. /
public 

string 
? 
FieldChanged 
{  !
get" %
;% &
set' *
;* +
}, -
public 

string 
? 
OldValue 
{ 
get !
;! "
set# &
;& '
}( )
public 

string 
? 
NewValue 
{ 
get !
;! "
set# &
;& '
}( )
public 

int 
? 
	ChangedBy 
{ 
get 
;  
set! $
;$ %
}& '
public 

DateTime 
? 
	Timestamp 
{  
get! $
;$ %
set& )
;) *
}+ ,
public 

virtual 
User 
? 
ChangedByNavigation ,
{- .
get/ 2
;2 3
set4 7
;7 8
}9 :
public 

virtual 
User 
User 
{ 
get "
;" #
set$ '
;' (
}) *
=+ ,
null- 1
!1 2
;2 3
} ö
yC:\Users\natha\OneDrive\Skrivebord\Kea-it-arkitektur\5. semester\TravelBuddy\src\Modules\TravelBuddy.Users\Models\User.cs
	namespace 	
TravelBuddy
 
. 
Users 
. 
Models "
;" #
public 
partial 
class 
User 
{ 
public 

int 
UserId 
{ 
get 
; 
set  
;  !
}" #
public 

string 
Name 
{ 
get 
; 
set !
;! "
}# $
=% &
null' +
!+ ,
;, -
public		 

string		 
Email		 
{		 
get		 
;		 
set		 "
;		" #
}		$ %
=		& '
null		( ,
!		, -
;		- .
public 

string 
PasswordHash 
{  
get! $
;$ %
set& )
;) *
}+ ,
=- .
null/ 3
!3 4
;4 5
public 

DateOnly 
	Birthdate 
{ 
get  #
;# $
set% (
;( )
}* +
public 

bool 
	IsDeleted 
{ 
get 
;  
set! $
;$ %
}& '
public 

string 
Role 
{ 
get 
; 
set !
;! "
}# $
=% &
null' +
!+ ,
;, -
public 

virtual 
ICollection 
< 
	UserAudit (
>( )

UserAudits* 4
{5 6
get7 :
;: ;
set< ?
;? @
}A B
=C D
newE H
ListI M
<M N
	UserAuditN W
>W X
(X Y
)Y Z
;Z [
} «
ÑC:\Users\natha\OneDrive\Skrivebord\Kea-it-arkitektur\5. semester\TravelBuddy\src\Modules\TravelBuddy.Users\IUserRepositoryFactory.cs
	namespace 	
TravelBuddy
 
. 
Users 
{ 
public 

	interface "
IUserRepositoryFactory +
{ 
IUserRepository 
GetUserRepository )
() *
)* +
;+ ,
} 
}		 û
}C:\Users\natha\OneDrive\Skrivebord\Kea-it-arkitektur\5. semester\TravelBuddy\src\Modules\TravelBuddy.Users\IUserRepository.cs
	namespace 	
TravelBuddy
 
. 
Users 
; 
public 
	interface 
IUserRepository  
{		 
Task

 
<

 	
User

	 
?

 
>

 
GetByEmailAsync

 
(

  
string

  &
email

' ,
)

, -
;

- .
Task 
AddAsync	 
( 
User 
user 
) 
; 
Task 
< 	
(	 

bool
 
Success 
, 
string 
? 
ErrorMessage  ,
), -
>- .
DeleteAsync/ :
(: ;
int; >
userId? E
,E F
stringG M
passwordHashN Z
)Z [
;[ \
Task 
< 	
(	 

bool
 
Success 
, 
string 
? 
ErrorMessage  ,
), -
>- .
UpdatePasswordAsync/ B
(B C
intC F
userIdG M
,M N
stringO U
passwordHashV b
)b c
;c d
Task 
< 	
User	 
? 
> 
GetUserByIdAsync  
(  !
int! $
userId% +
)+ ,
;, -
Task 
< 	
IEnumerable	 
< 
User 
> 
> 
GetAllAsync '
(' (
)( )
;) *
Task 
< 	
IEnumerable	 
< 
	UserAudit 
> 
>  
GetUserAuditsAsync! 3
(3 4
)4 5
;5 6
} ñ
ãC:\Users\natha\OneDrive\Skrivebord\Kea-it-arkitektur\5. semester\TravelBuddy\src\Modules\TravelBuddy.Users\Infrastructure\PasswordHasher.cs
	namespace 	
TravelBuddy
 
. 
Users 
. 
Infrastructure *
.* +
Security+ 3
{ 
public 

static 
class 
PasswordHasher &
{ 
public 
static 
string 
HashPassword )
() *
string* 0
password1 9
)9 :
{		 	
byte

 
[

 
]

 
salt

 
=

 !
RandomNumberGenerator

 /
.

/ 0
GetBytes

0 8
(

8 9
$num

9 <
/

= >
$num

? @
)

@ A
;

A B
string 
hashed 
= 
Convert #
.# $
ToBase64String$ 2
(2 3
KeyDerivation3 @
.@ A
Pbkdf2A G
(G H
password 
: 
password "
," #
salt 
: 
salt 
, 
prf 
: 
KeyDerivationPrf %
.% &

HMACSHA256& 0
,0 1
iterationCount 
: 
$num  '
,' (
numBytesRequested !
:! "
$num# &
/' (
$num) *
)* +
)+ ,
;, -
return 
$" 
{ 
Convert 
. 
ToBase64String ,
(, -
salt- 1
)1 2
}2 3
$str3 4
{4 5
hashed5 ;
}; <
"< =
;= >
} 	
public 
static 
bool 
VerifyPassword )
() *
string* 0
password1 9
,9 :
string; A

storedHashB L
)L M
{ 	
var 
parts 
= 

storedHash "
." #
Split# (
(( )
$char) ,
), -
;- .
if 
( 
parts 
. 
Length 
!= 
$num  !
)! "
return# )
false* /
;/ 0
var 
salt 
= 
Convert 
. 
FromBase64String /
(/ 0
parts0 5
[5 6
$num6 7
]7 8
)8 9
;9 :
var 
expectedHash 
= 
parts $
[$ %
$num% &
]& '
;' (
var 

actualHash 
= 
Convert $
.$ %
ToBase64String% 3
(3 4
KeyDerivation4 A
.A B
Pbkdf2B H
(H I
password 
: 
password "
," #
salt   
:   
salt   
,   
prf!! 
:!! 
KeyDerivationPrf!! %
.!!% &

HMACSHA256!!& 0
,!!0 1
iterationCount"" 
:"" 
$num""  '
,""' (
numBytesRequested## !
:##! "
$num### &
/##' (
$num##) *
)##* +
)##+ ,
;##, -
return%% 

actualHash%% 
==%%  
expectedHash%%! -
;%%- .
}&& 	
}'' 
}(( ‘m
ñC:\Users\natha\OneDrive\Skrivebord\Kea-it-arkitektur\5. semester\TravelBuddy\src\Modules\TravelBuddy.Users\Infrastructure\Neo4j\Neo4jUserRepository.cs
	namespace 	
TravelBuddy
 
. 
Users 
; 
public 
class 
Neo4jUserRepository  
:! "
IUserRepository# 2
{		 
private

 
readonly

 
IDriver

 
_driver

 $
;

$ %
public 

Neo4jUserRepository 
( 
IDriver &
driver' -
)- .
{ 
_driver 
= 
driver 
; 
} 
private 
static 
User 
MapRecordToUser '
(' (
IRecord( /
record0 6
)6 7
{ 
DateOnly 
	birthdate 
= 
default $
;$ %
if 

( 
record 
. 
Keys 
. 
Contains  
(  !
$str! ,
), -
&&. 0
record1 7
[7 8
$str8 C
]C D
isE G
	LocalDateH Q
ldR T
)T U
{ 	
	birthdate 
= 
new 
DateOnly $
($ %
ld% '
.' (
Year( ,
,, -
ld. 0
.0 1
Month1 6
,6 7
ld8 :
.: ;
Day; >
)> ?
;? @
} 	
return 
new 
User 
{ 	
UserId 
= 
record 
[ 
$str $
]$ %
.% &
As& (
<( )
int) ,
>, -
(- .
). /
,/ 0
Name 
= 
record 
[ 
$str  
]  !
.! "
As" $
<$ %
string% +
>+ ,
(, -
)- .
,. /
Email   
=   
record   
[   
$str   "
]  " #
.  # $
As  $ &
<  & '
string  ' -
>  - .
(  . /
)  / 0
,  0 1
PasswordHash!! 
=!! 
record!! !
[!!! "
$str!!" 0
]!!0 1
.!!1 2
As!!2 4
<!!4 5
string!!5 ;
>!!; <
(!!< =
)!!= >
,!!> ?
	Birthdate"" 
="" 
	birthdate"" !
,""! "
	IsDeleted## 
=## 
record## 
[## 
$str## *
]##* +
.##+ ,
As##, .
<##. /
bool##/ 3
>##3 4
(##4 5
)##5 6
,##6 7
Role$$ 
=$$ 
record$$ 
[$$ 
$str$$  
]$$  !
.$$! "
As$$" $
<$$$ %
string$$% +
>$$+ ,
($$, -
)$$- .
}%% 	
;%%	 

}&& 
private(( 
async(( 
Task(( 
<(( 
int(( 
>(( 
GetNextUserIdAsync(( .
(((. /
)((/ 0
{)) 
var** 
result** 
=** 
await** 
_driver** "
.++ 
ExecutableQuery++ 
(++ 
$str+. 
).. 
.// 
ExecuteAsync// 
(// 
)// 
;// 
var11 
record11 
=11 
result11 
.11 
Result11 "
.11" #
SingleOrDefault11# 2
(112 3
)113 4
;114 5
var22 
maxId22 
=22 
record22 
==22 
null22 "
?22# $
$num22% &
:22' (
record22) /
[22/ 0
$str220 7
]227 8
.228 9
As229 ;
<22; <
int22< ?
>22? @
(22@ A
)22A B
;22B C
return33 
maxId33 
+33 
$num33 
;33 
}44 
public88 

async88 
Task88 
<88 
User88 
?88 
>88 
GetByEmailAsync88 ,
(88, -
string88- 3
email884 9
)889 :
{99 
var:: 
result:: 
=:: 
await:: 
_driver:: "
.;; 
ExecutableQuery;; 
(;; 
$str;F 
)FF 
.GG 
WithParametersGG 
(GG 
newGG 
{GG  !
emailGG" '
}GG( )
)GG) *
.HH 
ExecuteAsyncHH 
(HH 
)HH 
;HH 
varJJ 
recordJJ 
=JJ 
resultJJ 
.JJ 
ResultJJ "
.JJ" #
SingleOrDefaultJJ# 2
(JJ2 3
)JJ3 4
;JJ4 5
returnKK 
recordKK 
==KK 
nullKK 
?KK 
nullKK  $
:KK% &
MapRecordToUserKK' 6
(KK6 7
recordKK7 =
)KK= >
;KK> ?
}LL 
publicNN 

asyncNN 
TaskNN 
AddAsyncNN 
(NN 
UserNN #
userNN$ (
)NN( )
{OO 
ifQQ 

(QQ 
userQQ 
.QQ 
UserIdQQ 
==QQ 
$numQQ 
)QQ 
{RR 	
userSS 
.SS 
UserIdSS 
=SS 
awaitSS 
GetNextUserIdAsyncSS  2
(SS2 3
)SS3 4
;SS4 5
}TT 	
awaitVV 
_driverVV 
.WW 
ExecutableQueryWW 
(WW 
$strWa 
)aa 
.bb 
WithParametersbb 
(bb 
newbb 
{cc 
userIddd 
=dd 
userdd 
.dd 
UserIddd $
,dd$ %
nameee 
=ee 
useree 
.ee 
Nameee  
,ee  !
emailff 
=ff 
userff 
.ff 
Emailff "
,ff" #
passwordHashgg 
=gg 
usergg #
.gg# $
PasswordHashgg$ 0
,gg0 1
	birthdatehh 
=hh 
userhh  
.hh  !
	Birthdatehh! *
.hh* +
ToStringhh+ 3
(hh3 4
$strhh4 @
)hh@ A
,hhA B
	isDeletedii 
=ii 
userii  
.ii  !
	IsDeletedii! *
,ii* +
rolejj 
=jj 
userjj 
.jj 
Rolejj  
}kk 
)kk 
.ll 
ExecuteAsyncll 
(ll 
)ll 
;ll 
}mm 
publicoo 

asyncoo 
Taskoo 
<oo 
(oo 
booloo 
Successoo #
,oo# $
stringoo% +
?oo+ ,
ErrorMessageoo- 9
)oo9 :
>oo: ;
DeleteAsyncoo< G
(ooG H
intooH K
userIdooL R
,ooR S
stringooT Z
passwordHashoo[ g
)oog h
{pp 
ifqq 

(qq 
stringqq 
.qq 
IsNullOrWhiteSpaceqq %
(qq% &
passwordHashqq& 2
)qq2 3
)qq3 4
returnqq5 ;
(qq< =
falseqq= B
,qqB C
$strqqD `
)qq` a
;qqa b
tryss 
{ss 
vartt 
resulttt 
=tt 
awaittt 
_drivertt &
.uu 
ExecutableQueryuu  
(uu  !
$struz! 
)zz 
.{{ 
WithParameters{{ 
({{  
new{{  #
{{{$ %
userId{{& ,
,{{, -
passwordHash{{. :
}{{; <
){{< =
.|| 
ExecuteAsync|| 
(|| 
)|| 
;||  
var~~ 
record~~ 
=~~ 
result~~ 
.~~  
Result~~  &
.~~& '
SingleOrDefault~~' 6
(~~6 7
)~~7 8
;~~8 9
if 
( 
record 
== 
null 
) 
return  &
(' (
false( -
,- .
$str/ @
)@ A
;A B
var
ÅÅ 
updatedCount
ÅÅ 
=
ÅÅ 
record
ÅÅ %
[
ÅÅ% &
$str
ÅÅ& 4
]
ÅÅ4 5
.
ÅÅ5 6
As
ÅÅ6 8
<
ÅÅ8 9
long
ÅÅ9 =
>
ÅÅ= >
(
ÅÅ> ?
)
ÅÅ? @
;
ÅÅ@ A
return
ÇÇ 
updatedCount
ÇÇ 
==
ÇÇ  "
$num
ÇÇ# $
?
ÇÇ% &
(
ÇÇ' (
true
ÇÇ( ,
,
ÇÇ, -
null
ÇÇ. 2
)
ÇÇ2 3
:
ÇÇ4 5
(
ÇÇ6 7
false
ÇÇ7 <
,
ÇÇ< =
$str
ÇÇ> O
)
ÇÇO P
;
ÇÇP Q
}
ÉÉ 	
catch
ÉÉ
 
(
ÉÉ 
	Exception
ÉÉ 
ex
ÉÉ 
)
ÉÉ 
{
ÉÉ  
return
ÑÑ 
(
ÑÑ 
false
ÑÑ 
,
ÑÑ 
ex
ÑÑ 
.
ÑÑ 
Message
ÑÑ %
??
ÑÑ& (
$str
ÑÑ) U
)
ÑÑU V
;
ÑÑV W
}
ÖÖ 	
}
ÜÜ 
public
àà 

async
àà 
Task
àà 
<
àà 
(
àà 
bool
àà 
Success
àà #
,
àà# $
string
àà% +
?
àà+ ,
ErrorMessage
àà- 9
)
àà9 :
>
àà: ;!
UpdatePasswordAsync
àà< O
(
ààO P
int
ààP S
userId
ààT Z
,
ààZ [
string
àà\ b
passwordHash
ààc o
)
àào p
{
ââ 
if
ää 

(
ää 
string
ää 
.
ää  
IsNullOrWhiteSpace
ää %
(
ää% &
passwordHash
ää& 2
)
ää2 3
)
ää3 4
return
ää5 ;
(
ää< =
false
ää= B
,
ääB C
$str
ääD `
)
ää` a
;
ääa b
try
åå 
{
åå 
await
çç 
_driver
çç 
.
éé 
ExecutableQuery
éé  
(
éé  !
$str
éí! 
)
íí 
.
ìì 
WithParameters
ìì 
(
ìì  
new
ìì  #
{
ìì$ %
userId
ìì& ,
,
ìì, -
passwordHash
ìì. :
}
ìì; <
)
ìì< =
.
îî 
ExecuteAsync
îî 
(
îî 
)
îî 
;
îî  
return
ïï 
(
ïï 
true
ïï 
,
ïï 
null
ïï 
)
ïï 
;
ïï  
}
ññ 	
catch
ññ
 
(
ññ 
	Exception
ññ 
ex
ññ 
)
ññ 
{
ññ  
return
óó 
(
óó 
false
óó 
,
óó 
ex
óó 
.
óó 
Message
óó %
??
óó& (
$str
óó) Y
)
óóY Z
;
óóZ [
}
òò 	
}
ôô 
public
õõ 

async
õõ 
Task
õõ 
<
õõ 
User
õõ 
?
õõ 
>
õõ 
GetUserByIdAsync
õõ -
(
õõ- .
int
õõ. 1
userId
õõ2 8
)
õõ8 9
{
úú 
var
ùù 
result
ùù 
=
ùù 
await
ùù 
_driver
ùù "
.
ûû 
ExecutableQuery
ûû 
(
ûû 
$str
û© 
)
©© 
.
™™ 
WithParameters
™™ 
(
™™ 
new
™™ 
{
™™  !
userId
™™" (
}
™™) *
)
™™* +
.
´´ 
ExecuteAsync
´´ 
(
´´ 
)
´´ 
;
´´ 
var
≠≠ 
record
≠≠ 
=
≠≠ 
result
≠≠ 
.
≠≠ 
Result
≠≠ "
.
≠≠" #
SingleOrDefault
≠≠# 2
(
≠≠2 3
)
≠≠3 4
;
≠≠4 5
return
ÆÆ 
record
ÆÆ 
==
ÆÆ 
null
ÆÆ 
?
ÆÆ 
null
ÆÆ  $
:
ÆÆ% &
MapRecordToUser
ÆÆ' 6
(
ÆÆ6 7
record
ÆÆ7 =
)
ÆÆ= >
;
ÆÆ> ?
}
ØØ 
public
±± 

async
±± 
Task
±± 
<
±± 
IEnumerable
±± !
<
±±! "
User
±±" &
>
±±& '
>
±±' (
GetAllAsync
±±) 4
(
±±4 5
)
±±5 6
{
≤≤ 
var
≥≥ 
result
≥≥ 
=
≥≥ 
await
≥≥ 
_driver
≥≥ "
.
¥¥ 
ExecutableQuery
¥¥ 
(
¥¥ 
$str
¥ø 
)
øø 
.
¿¿ 
ExecuteAsync
¿¿ 
(
¿¿ 
)
¿¿ 
;
¿¿ 
return
¬¬ 
result
¬¬ 
.
¬¬ 
Result
¬¬ 
.
¬¬ 
Select
¬¬ #
(
¬¬# $
MapRecordToUser
¬¬$ 3
)
¬¬3 4
.
¬¬4 5
ToList
¬¬5 ;
(
¬¬; <
)
¬¬< =
;
¬¬= >
}
√√ 
public
≈≈ 

async
≈≈ 
Task
≈≈ 
<
≈≈ 
IEnumerable
≈≈ !
<
≈≈! "
	UserAudit
≈≈" +
>
≈≈+ ,
>
≈≈, - 
GetUserAuditsAsync
≈≈. @
(
≈≈@ A
)
≈≈A B
{
∆∆ 
return
»» 
await
»» 
Task
»» 
.
»» 

FromResult
»» $
<
»»$ %
IEnumerable
»»% 0
<
»»0 1
	UserAudit
»»1 :
>
»»: ;
>
»»; <
(
»»< =
new
»»= @
List
»»A E
<
»»E F
	UserAudit
»»F O
>
»»O P
(
»»P Q
)
»»Q R
)
»»R S
;
»»S T
}
…… 
}   »L
ëC:\Users\natha\OneDrive\Skrivebord\Kea-it-arkitektur\5. semester\TravelBuddy\src\Modules\TravelBuddy.Users\Infrastructure\MySql\UsersDbContext.cs
	namespace 	
TravelBuddy
 
. 
Users 
. 
Infrastructure *
;* +
public 
partial 
class 
UsersDbContext #
:$ %
	DbContext& /
{ 
public 

UsersDbContext 
( 
DbContextOptions *
<* +
UsersDbContext+ 9
>9 :
options; B
)B C
:		 	
base		
 
(		 
options		 
)		 
{

 
} 
public 

virtual 
DbSet 
< 
User 
> 
Users $
{% &
get' *
;* +
set, /
;/ 0
}1 2
public 

virtual 
DbSet 
< 
	UserAudit "
>" #

UserAudits$ .
{/ 0
get1 4
;4 5
set6 9
;9 :
}; <
	protected 
override 
void 
OnModelCreating +
(+ ,
ModelBuilder, 8
modelBuilder9 E
)E F
{ 
modelBuilder 
. 
UseCollation 
( 
$str .
). /
. 

HasCharSet 
( 
$str !
)! "
;" #
modelBuilder 
. 
Entity 
< 
User  
>  !
(! "
entity" (
=>) +
{ 	
entity 
. 
HasKey 
( 
e 
=> 
e  
.  !
UserId! '
)' (
.( )
HasName) 0
(0 1
$str1 :
): ;
;; <
entity 
. 
ToTable 
( 
$str !
)! "
;" #
entity 
. 
HasIndex 
( 
e 
=>  
e! "
." #
Email# (
,( )
$str* 1
)1 2
.2 3
IsUnique3 ;
(; <
)< =
;= >
entity 
. 
Property 
( 
e 
=>  
e! "
." #
UserId# )
)) *
.* +
HasColumnName+ 8
(8 9
$str9 B
)B C
;C D
entity   
.   
Property   
(   
e   
=>    
e  ! "
.  " #
	Birthdate  # ,
)  , -
.  - .
HasColumnName  . ;
(  ; <
$str  < G
)  G H
;  H I
entity!! 
.!! 
Property!! 
(!! 
e!! 
=>!!  
e!!! "
.!!" #
Email!!# (
)!!( )
."" 
HasMaxLength"" 
("" 
$num"" !
)""! "
.## 
HasColumnName## 
(## 
$str## &
)##& '
;##' (
entity$$ 
.$$ 
Property$$ 
($$ 
e$$ 
=>$$  
e$$! "
.$$" #
	IsDeleted$$# ,
)$$, -
.%% 
HasDefaultValueSql%% #
(%%# $
$str%%$ )
)%%) *
.&& 
HasColumnName&& 
(&& 
$str&& +
)&&+ ,
;&&, -
entity'' 
.'' 
Property'' 
('' 
e'' 
=>''  
e''! "
.''" #
Name''# '
)''' (
.(( 
HasMaxLength(( 
((( 
$num(( !
)((! "
.)) 
HasColumnName)) 
()) 
$str)) %
)))% &
;))& '
entity** 
.** 
Property** 
(** 
e** 
=>**  
e**! "
.**" #
PasswordHash**# /
)**/ 0
.++ 
HasMaxLength++ 
(++ 
$num++ !
)++! "
.,, 
HasColumnName,, 
(,, 
$str,, .
),,. /
;,,/ 0
entity-- 
.-- 
Property-- 
(-- 
e-- 
=>--  
e--! "
.--" #
Role--# '
)--' (
... 
HasDefaultValueSql.. #
(..# $
$str..$ ,
).., -
.// 
HasColumnType// 
(// 
$str// 5
)//5 6
.00 
HasColumnName00 
(00 
$str00 %
)00% &
;00& '
}11 	
)11	 

;11
 
modelBuilder33 
.33 
Entity33 
<33 
	UserAudit33 %
>33% &
(33& '
entity33' -
=>33. 0
{44 	
entity55 
.55 
HasKey55 
(55 
e55 
=>55 
e55  
.55  !
AuditId55! (
)55( )
.55) *
HasName55* 1
(551 2
$str552 ;
)55; <
;55< =
entity77 
.77 
ToTable77 
(77 
$str77 '
)77' (
;77( )
entity88 
.88 
HasIndex88 
(88 
e88 
=>88  
e88! "
.88" #
UserId88# )
,88) *
$str88+ ?
)88? @
;88@ A
entity:: 
.:: 
HasIndex:: 
(:: 
e:: 
=>::  
e::! "
.::" #
	ChangedBy::# ,
,::, -
$str::. H
)::H I
;::I J
entity<< 
.<< 
Property<< 
(<< 
e<< 
=><<  
e<<! "
.<<" #
AuditId<<# *
)<<* +
.<<+ ,
HasColumnName<<, 9
(<<9 :
$str<<: D
)<<D E
;<<E F
entity== 
.== 
Property== 
(== 
e== 
=>==  
e==! "
.==" #
Action==# )
)==) *
.>> 
HasColumnType>> 
(>> 
$str>> D
)>>D E
.?? 
HasColumnName?? 
(?? 
$str?? '
)??' (
;??( )
entity@@ 
.@@ 
Property@@ 
(@@ 
e@@ 
=>@@  
e@@! "
.@@" #
	ChangedBy@@# ,
)@@, -
.@@- .
HasColumnName@@. ;
(@@; <
$str@@< H
)@@H I
;@@I J
entityAA 
.AA 
PropertyAA 
(AA 
eAA 
=>AA  
eAA! "
.AA" #
FieldChangedAA# /
)AA/ 0
.BB 
HasMaxLengthBB 
(BB 
$numBB !
)BB! "
.CC 
HasColumnNameCC 
(CC 
$strCC .
)CC. /
;CC/ 0
entityDD 
.DD 
PropertyDD 
(DD 
eDD 
=>DD  
eDD! "
.DD" #
NewValueDD# +
)DD+ ,
.EE 
HasMaxLengthEE 
(EE 
$numEE !
)EE! "
.FF 
HasColumnNameFF 
(FF 
$strFF *
)FF* +
;FF+ ,
entityGG 
.GG 
PropertyGG 
(GG 
eGG 
=>GG  
eGG! "
.GG" #
OldValueGG# +
)GG+ ,
.HH 
HasMaxLengthHH 
(HH 
$numHH !
)HH! "
.II 
HasColumnNameII 
(II 
$strII *
)II* +
;II+ ,
entityJJ 
.JJ 
PropertyJJ 
(JJ 
eJJ 
=>JJ  
eJJ! "
.JJ" #
	TimestampJJ# ,
)JJ, -
.KK 
HasDefaultValueSqlKK #
(KK# $
$strKK$ 7
)KK7 8
.LL 
HasColumnTypeLL 
(LL 
$strLL )
)LL) *
.MM 
HasColumnNameMM 
(MM 
$strMM *
)MM* +
;MM+ ,
entityNN 
.NN 
PropertyNN 
(NN 
eNN 
=>NN  
eNN! "
.NN" #
UserIdNN# )
)NN) *
.NN* +
HasColumnNameNN+ 8
(NN8 9
$strNN9 B
)NNB C
;NNC D
entityPP 
.PP 
IgnorePP 
(PP 
ePP 
=>PP 
ePP  
.PP  !
ChangedByNavigationPP! 4
)PP4 5
;PP5 6
entityRR 
.RR 
HasOneRR 
(RR 
dRR 
=>RR 
dRR  
.RR  !
UserRR! %
)RR% &
.RR& '
WithManyRR' /
(RR/ 0
pRR0 1
=>RR2 4
pRR5 6
.RR6 7

UserAuditsRR7 A
)RRA B
.SS 
HasForeignKeySS 
(SS 
dSS  
=>SS! #
dSS$ %
.SS% &
UserIdSS& ,
)SS, -
.TT 
HasConstraintNameTT "
(TT" #
$strTT# 7
)TT7 8
;TT8 9
}UU 	
)UU	 

;UU
 "
OnModelCreatingPartialWW 
(WW 
modelBuilderWW +
)WW+ ,
;WW, -
}XX 
partialZZ 
voidZZ "
OnModelCreatingPartialZZ '
(ZZ' (
ModelBuilderZZ( 4
modelBuilderZZ5 A
)ZZA B
;ZZB C
}[[ ƒ2
ñC:\Users\natha\OneDrive\Skrivebord\Kea-it-arkitektur\5. semester\TravelBuddy\src\Modules\TravelBuddy.Users\Infrastructure\MySql\MySqlUserRepository.cs
	namespace 	
TravelBuddy
 
. 
Users 
; 
public 
class 
MySqlUserRepository  
:! "
IUserRepository# 2
{ 
private

 
readonly

 
UsersDbContext

 #
_context

$ ,
;

, -
public 

MySqlUserRepository 
( 
UsersDbContext -
context. 5
)5 6
{ 
_context 
= 
context 
; 
} 
public 

async 
Task 
< 
User 
? 
> 
GetByEmailAsync ,
(, -
string- 3
email4 9
)9 :
{ 
return 
await 
_context 
. 
Users #
.# $
FirstOrDefaultAsync$ 7
(7 8
u8 9
=>: <
u= >
.> ?
Email? D
==E G
emailH M
)M N
;N O
} 
public 

async 
Task 
AddAsync 
( 
User #
user$ (
)( )
{ 
_context 
. 
Users 
. 
Add 
( 
user 
)  
;  !
await 
_context 
. 
SaveChangesAsync '
(' (
)( )
;) *
} 
public 

async 
Task 
< 
( 
bool 
Success #
,# $
string% +
?+ ,
ErrorMessage- 9
)9 :
>: ;
DeleteAsync< G
(G H
intH K
userIdL R
,R S
stringT Z
passwordHash[ g
)g h
{ 
if 

( 
string 
. 
IsNullOrWhiteSpace %
(% &
passwordHash& 2
)2 3
)3 4
return5 ;
(< =
false= B
,B C
$strD `
)` a
;a b
try 
{ 
var 
result 
= 
await 
_context '
.' (
Database( 0
.0 1'
ExecuteSqlInterpolatedAsync1 L
(L M
$@"M P
$strP a
{a b
userIdb h
}h i
$stri k
{k l
passwordHashl x
}x y
$stry z
"z {
){ |
;| }
return 
( 
true 
, 
null 
) 
;  
}   	
catch  
 
(   
	Exception   
ex   
)   
{    
return!! 
(!! 
false!! 
,!! 
ex!! 
.!! 
Message!! %
??!!& (
$str!!) U
)!!U V
;!!V W
}"" 	
}## 
public$$ 

async$$ 
Task$$ 
<$$ 
($$ 
bool$$ 
Success$$ #
,$$# $
string$$% +
?$$+ ,
ErrorMessage$$- 9
)$$9 :
>$$: ;
UpdatePasswordAsync$$< O
($$O P
int$$P S
userId$$T Z
,$$Z [
string$$\ b
passwordHash$$c o
)$$o p
{%% 
try&& 
{&& 
var'' 
user'' 
='' 
await'' 
_context'' %
.''% &
Users''& +
.''+ ,
	FindAsync'', 5
(''5 6
userId''6 <
)''< =
;''= >
if)) 
()) 
user)) 
==)) 
null)) 
))) 
return)) $
())% &
false))& +
,))+ ,
$str))- >
)))> ?
;))? @
user++ 
.++ 
PasswordHash++ 
=++ 
passwordHash++  ,
;++, -
await,, 
_context,, 
.,, 
SaveChangesAsync,, +
(,,+ ,
),,, -
;,,- .
return-- 
(-- 
true-- 
,-- 
null-- 
)-- 
;--  
}// 	
catch//
 
(// 
	Exception// 
ex// 
)// 
{//  
return00 
(00 
false00 
,00 
ex00 
.00 
Message00 %
??00& (
$str00) Y
)00Y Z
;00Z [
}11 	
}22 
public33 

async33 
Task33 
<33 
User33 
?33 
>33 
GetUserByIdAsync33 -
(33- .
int33. 1
userId332 8
)338 9
{44 
return55 
await55 
_context55 
.55 
Users55 #
.66 
FirstOrDefaultAsync66  
(66  !
u66! "
=>66# %
u66& '
.66' (
UserId66( .
==66/ 1
userId662 8
)668 9
;669 :
}77 
public88 

async88 
Task88 
<88 
IEnumerable88 !
<88! "
User88" &
>88& '
>88' (
GetAllAsync88) 4
(884 5
)885 6
{99 
return;; 
await;; 
_context;; 
.;; 
Users;; #
.>> 
AsNoTracking>> 
(>> 
)>> 
.?? 
ToListAsync?? 
(?? 
)?? 
;?? 
}@@ 
publicBB 

asyncBB 
TaskBB 
<BB 
IEnumerableBB !
<BB! "
	UserAuditBB" +
>BB+ ,
>BB, -
GetUserAuditsAsyncBB. @
(BB@ A
)BBA B
{CC 
returnDD 
awaitDD 
_contextDD 
.DD 

UserAuditsDD (
.EE 
AsNoTrackingEE 
(EE 
)EE 
.FF 
ToListAsyncFF 
(FF 
)FF 
;FF 
}GG 
}HH ô{
öC:\Users\natha\OneDrive\Skrivebord\Kea-it-arkitektur\5. semester\TravelBuddy\src\Modules\TravelBuddy.Users\Infrastructure\MongoDb\MongoDbUserRepository.cs
	namespace

 	
TravelBuddy


 
.

 
Users

 
{ 
internal 
class 
UserDocument 
{ 
[ 	
BsonId	 
] 
public 
int 
UserId 
{ 
get 
;  
set! $
;$ %
}& '
public 
string 
Name 
{ 
get  
;  !
set" %
;% &
}' (
=) *
null+ /
!/ 0
;0 1
public 
string 
Email 
{ 
get !
;! "
set# &
;& '
}( )
=* +
null, 0
!0 1
;1 2
public 
string 
PasswordHash "
{# $
get% (
;( )
set* -
;- .
}/ 0
=1 2
null3 7
!7 8
;8 9
public 
DateTime 
? 
	Birthdate "
{# $
get% (
;( )
set* -
;- .
}/ 0
public 
bool 
	IsDeleted 
{ 
get  #
;# $
set% (
;( )
}* +
public 
string 
Role 
{ 
get  
;  !
set" %
;% &
}' (
=) *
null+ /
!/ 0
;0 1
} 
public 

class !
MongoDbUserRepository &
:' (
IUserRepository) 8
{ 
private!! 
readonly!! 
IMongoCollection!! )
<!!) *
UserDocument!!* 6
>!!6 7
_usersCollection!!8 H
;!!H I
public## !
MongoDbUserRepository## $
(##$ %
IMongoClient##% 1
client##2 8
)##8 9
{$$ 	
var&& 
database&& 
=&& 
client&& !
.&&! "
GetDatabase&&" -
(&&- .
$str&&. B
)&&B C
;&&C D
_usersCollection'' 
='' 
database'' '
.''' (
GetCollection''( 5
<''5 6
UserDocument''6 B
>''B C
(''C D
$str''D K
)''K L
;''L M
}(( 	
private,, 
static,, 
User,, 
MapToEntity,, '
(,,' (
UserDocument,,( 4
doc,,5 8
),,8 9
{-- 	
return.. 
new.. 
User.. 
{// 
UserId00 
=00 
doc00 
.00 
UserId00 #
,00# $
Name11 
=11 
doc11 
.11 
Name11 
,11  
Email22 
=22 
doc22 
.22 
Email22 !
,22! "
PasswordHash33 
=33 
doc33 "
.33" #
PasswordHash33# /
,33/ 0
	Birthdate44 
=44 
doc44 
.44  
	Birthdate44  )
.44) *
HasValue44* 2
?55 
DateOnly55 
.55 
FromDateTime55 +
(55+ ,
doc55, /
.55/ 0
	Birthdate550 9
.559 :
Value55: ?
)55? @
:66 
default66 
,66 
	IsDeleted77 
=77 
doc77 
.77  
	IsDeleted77  )
,77) *
Role88 
=88 
doc88 
.88 
Role88 
}99 
;99 
}:: 	
private>> 
async>> 
Task>> 
<>> 
int>> 
>>> 
GetNextUserIdAsync>>  2
(>>2 3
)>>3 4
{?? 	
var@@ 
last@@ 
=@@ 
await@@ 
_usersCollection@@ -
.AA 
FindAA 
(AA 
FilterDefinitionAA &
<AA& '
UserDocumentAA' 3
>AA3 4
.AA4 5
EmptyAA5 :
)AA: ;
.BB 
SortByDescendingBB !
(BB! "
uBB" #
=>BB$ &
uBB' (
.BB( )
UserIdBB) /
)BB/ 0
.CC 
LimitCC 
(CC 
$numCC 
)CC 
.DD 
FirstOrDefaultAsyncDD $
(DD$ %
)DD% &
;DD& '
returnFF 
(FF 
lastFF 
?FF 
.FF 
UserIdFF  
??FF! #
$numFF$ %
)FF% &
+FF' (
$numFF) *
;FF* +
}GG 	
publicLL 
asyncLL 
TaskLL 
<LL 
UserLL 
?LL 
>LL  
GetByEmailAsyncLL! 0
(LL0 1
stringLL1 7
emailLL8 =
)LL= >
{MM 	
varNN 
filterNN 
=NN 
BuildersNN !
<NN! "
UserDocumentNN" .
>NN. /
.NN/ 0
FilterNN0 6
.NN6 7
EqNN7 9
(NN9 :
uNN: ;
=>NN< >
uNN? @
.NN@ A
EmailNNA F
,NNF G
emailNNH M
)NNM N
;NNN O
varPP 
docPP 
=PP 
awaitPP 
_usersCollectionPP ,
.QQ 
FindQQ 
(QQ 
filterQQ 
)QQ 
.RR 
FirstOrDefaultAsyncRR $
(RR$ %
)RR% &
;RR& '
returnTT 
docTT 
==TT 
nullTT 
?TT  
nullTT! %
:TT& '
MapToEntityTT( 3
(TT3 4
docTT4 7
)TT7 8
;TT8 9
}UU 	
public[[ 
async[[ 
Task[[ 
<[[ 
User[[ 
?[[ 
>[[  
GetUserByIdAsync[[! 1
([[1 2
int[[2 5
userId[[6 <
)[[< =
{\\ 	
var]] 
filter]] 
=]] 
Builders]] !
<]]! "
UserDocument]]" .
>]]. /
.]]/ 0
Filter]]0 6
.]]6 7
Eq]]7 9
(]]9 :
u]]: ;
=>]]< >
u]]? @
.]]@ A
UserId]]A G
,]]G H
userId]]I O
)]]O P
;]]P Q
var__ 
doc__ 
=__ 
await__ 
_usersCollection__ ,
.`` 
Find`` 
(`` 
filter`` 
)`` 
.aa 
FirstOrDefaultAsyncaa $
(aa$ %
)aa% &
;aa& '
returncc 
doccc 
==cc 
nullcc 
?cc  
nullcc! %
:cc& '
MapToEntitycc( 3
(cc3 4
doccc4 7
)cc7 8
;cc8 9
}dd 	
publicii 
asyncii 
Taskii 
AddAsyncii "
(ii" #
Userii# '
userii( ,
)ii, -
{jj 	
ifll 
(ll 
userll 
.ll 
UserIdll 
==ll 
$numll  
)ll  !
{mm 
usernn 
.nn 
UserIdnn 
=nn 
awaitnn #
GetNextUserIdAsyncnn$ 6
(nn6 7
)nn7 8
;nn8 9
}oo 
varqq 
docqq 
=qq 
newqq 
UserDocumentqq &
{rr 
UserIdss 
=ss 
userss 
.ss 
UserIdss $
,ss$ %
Namett 
=tt 
usertt 
.tt 
Namett  
,tt  !
Emailuu 
=uu 
useruu 
.uu 
Emailuu "
,uu" #
PasswordHashvv 
=vv 
uservv #
.vv# $
PasswordHashvv$ 0
,vv0 1
	Birthdateww 
=ww 
userww  
.ww  !
	Birthdateww! *
!=ww+ -
defaultww. 5
?xx 
userxx 
.xx 
	Birthdatexx $
.xx$ %

ToDateTimexx% /
(xx/ 0
TimeOnlyxx0 8
.xx8 9
MinValuexx9 A
)xxA B
:yy 
nullyy 
,yy 
	IsDeletedzz 
=zz 
userzz  
.zz  !
	IsDeletedzz! *
,zz* +
Role{{ 
={{ 
user{{ 
.{{ 
Role{{  
}|| 
;|| 
await 
_usersCollection "
." #
InsertOneAsync# 1
(1 2
doc2 5
)5 6
;6 7
}
ÄÄ 	
public
ÖÖ 
async
ÖÖ 
Task
ÖÖ 
<
ÖÖ 
(
ÖÖ 
bool
ÖÖ 
Success
ÖÖ  '
,
ÖÖ' (
string
ÖÖ) /
?
ÖÖ/ 0
ErrorMessage
ÖÖ1 =
)
ÖÖ= >
>
ÖÖ> ?
DeleteAsync
ÖÖ@ K
(
ÖÖK L
int
ÖÖL O
userId
ÖÖP V
,
ÖÖV W
string
ÖÖX ^
passwordHash
ÖÖ_ k
)
ÖÖk l
{
ÜÜ 	
try
áá 
{
áá 
var
àà 
filter
àà 
=
àà 
Builders
àà %
<
àà% &
UserDocument
àà& 2
>
àà2 3
.
àà3 4
Filter
àà4 :
.
àà: ;
Eq
àà; =
(
àà= >
u
àà> ?
=>
àà@ B
u
ààC D
.
ààD E
UserId
ààE K
,
ààK L
userId
ààM S
)
ààS T
;
ààT U
var
ää 
update
ää 
=
ää 
Builders
ää %
<
ää% &
UserDocument
ää& 2
>
ää2 3
.
ää3 4
Update
ää4 :
.
ãã 
Set
ãã 
(
ãã 
u
ãã 
=>
ãã 
u
ãã 
.
ãã  
	IsDeleted
ãã  )
,
ãã) *
true
ãã+ /
)
ãã/ 0
.
åå 
Set
åå 
(
åå 
u
åå 
=>
åå 
u
åå 
.
åå  
PasswordHash
åå  ,
,
åå, -
passwordHash
åå. :
)
åå: ;
;
åå; <
var
éé 
result
éé 
=
éé 
await
éé "
_usersCollection
éé# 3
.
éé3 4
UpdateOneAsync
éé4 B
(
ééB C
filter
ééC I
,
ééI J
update
ééK Q
)
ééQ R
;
ééR S
return
êê 
(
êê 
result
êê 
.
êê 
IsAcknowledged
êê -
&&
êê. 0
result
êê1 7
.
êê7 8
ModifiedCount
êê8 E
==
êêF H
$num
êêI J
,
êêJ K
null
êêL P
)
êêP Q
;
êêQ R
}
íí 
catch
ìì 
(
ìì 
	Exception
ìì 
ex
ìì 
)
ìì  
{
ìì! "
return
îî 
(
îî 
false
îî 
,
îî 
ex
îî !
.
îî! "
Message
îî" )
??
îî* ,
$str
îî- Y
)
îîY Z
;
îîZ [
}
ïï 
}
ññ 	
public
õõ 
async
õõ 
Task
õõ 
<
õõ 
(
õõ 
bool
õõ 
Success
õõ  '
,
õõ' (
string
õõ) /
?
õõ/ 0
ErrorMessage
õõ1 =
)
õõ= >
>
õõ> ?!
UpdatePasswordAsync
õõ@ S
(
õõS T
int
õõT W
userId
õõX ^
,
õõ^ _
string
õõ` f
passwordHash
õõg s
)
õõs t
{
úú 	
try
ùù 
{
ùù 
var
ûû 
filter
ûû 
=
ûû 
Builders
ûû %
<
ûû% &
UserDocument
ûû& 2
>
ûû2 3
.
ûû3 4
Filter
ûû4 :
.
ûû: ;
And
ûû; >
(
ûû> ?
Builders
üü 
<
üü 
UserDocument
üü )
>
üü) *
.
üü* +
Filter
üü+ 1
.
üü1 2
Eq
üü2 4
(
üü4 5
u
üü5 6
=>
üü7 9
u
üü: ;
.
üü; <
UserId
üü< B
,
üüB C
userId
üüD J
)
üüJ K
,
üüK L
Builders
†† 
<
†† 
UserDocument
†† )
>
††) *
.
††* +
Filter
††+ 1
.
††1 2
Eq
††2 4
(
††4 5
u
††5 6
=>
††7 9
u
††: ;
.
††; <
	IsDeleted
††< E
,
††E F
false
††G L
)
††L M
)
°° 
;
°° 
var
££ 
update
££ 
=
££ 
Builders
££ %
<
££% &
UserDocument
££& 2
>
££2 3
.
££3 4
Update
££4 :
.
§§ 
Set
§§ 
(
§§ 
u
§§ 
=>
§§ 
u
§§ 
.
§§  
PasswordHash
§§  ,
,
§§, -
passwordHash
§§. :
)
§§: ;
;
§§; <
await
¶¶ 
_usersCollection
¶¶ &
.
¶¶& '
UpdateOneAsync
¶¶' 5
(
¶¶5 6
filter
¶¶6 <
,
¶¶< =
update
¶¶> D
)
¶¶D E
;
¶¶E F
return
ßß 
(
ßß 
true
ßß 
,
ßß 
null
ßß "
)
ßß" #
;
ßß# $
}
©© 
catch
©© 
(
©© 
	Exception
©© 
ex
©© !
)
©©! "
{
©©# $
return
™™ 
(
™™ 
false
™™ 
,
™™ 
ex
™™ !
.
™™! "
Message
™™" )
??
™™* ,
$str
™™- ]
)
™™] ^
;
™™^ _
}
´´ 
}
¨¨ 	
public
±± 
async
±± 
Task
±± 
<
±± 
IEnumerable
±± %
<
±±% &
User
±±& *
>
±±* +
>
±±+ ,
GetAllAsync
±±- 8
(
±±8 9
)
±±9 :
{
≤≤ 	
var
≥≥ 
filter
≥≥ 
=
≥≥ 
Builders
≥≥ !
<
≥≥! "
UserDocument
≥≥" .
>
≥≥. /
.
≥≥/ 0
Filter
≥≥0 6
.
≥≥6 7
Eq
≥≥7 9
(
≥≥9 :
u
≥≥: ;
=>
≥≥< >
u
≥≥? @
.
≥≥@ A
	IsDeleted
≥≥A J
,
≥≥J K
false
≥≥L Q
)
≥≥Q R
;
≥≥R S
var
µµ 
docs
µµ 
=
µµ 
await
µµ 
_usersCollection
µµ -
.
∂∂ 
Find
∂∂ 
(
∂∂ 
filter
∂∂ 
)
∂∂ 
.
∑∑ 
ToListAsync
∑∑ 
(
∑∑ 
)
∑∑ 
;
∑∑ 
return
∫∫ 
docs
∫∫ 
.
∫∫ 
Select
∫∫ 
(
∫∫ 
MapToEntity
∫∫ *
)
∫∫* +
.
∫∫+ ,
ToList
∫∫, 2
(
∫∫2 3
)
∫∫3 4
;
∫∫4 5
}
ªª 	
public
ΩΩ 
async
ΩΩ 
Task
ΩΩ 
<
ΩΩ 
IEnumerable
ΩΩ %
<
ΩΩ% &
	UserAudit
ΩΩ& /
>
ΩΩ/ 0
>
ΩΩ0 1 
GetUserAuditsAsync
ΩΩ2 D
(
ΩΩD E
)
ΩΩE F
{
ææ 	
return
¿¿ 
await
¿¿ 
Task
¿¿ 
.
¿¿ 

FromResult
¿¿ (
<
¿¿( )
IEnumerable
¿¿) 4
<
¿¿4 5
	UserAudit
¿¿5 >
>
¿¿> ?
>
¿¿? @
(
¿¿@ A
new
¿¿A D
List
¿¿E I
<
¿¿I J
	UserAudit
¿¿J S
>
¿¿S T
(
¿¿T U
)
¿¿U V
)
¿¿V W
;
¿¿W X
}
¡¡ 	
}
¬¬ 
}√√ Ω
zC:\Users\natha\OneDrive\Skrivebord\Kea-it-arkitektur\5. semester\TravelBuddy\src\Modules\TravelBuddy.Users\DTOs\UserDto.cs
	namespace 	
TravelBuddy
 
. 
Users 
. 
DTOs  
{ 
public 

record 
UserDto 
( 
int 
UserId 
, 
string 
Name 
, 
string 
Email 
, 
DateOnly		 
	Birthdate		 
)

 
;

 
} Ï
C:\Users\natha\OneDrive\Skrivebord\Kea-it-arkitektur\5. semester\TravelBuddy\src\Modules\TravelBuddy.Users\DTOs\UserAuditDto.cs
	namespace 	
TravelBuddy
 
. 
Users 
. 
Models "
;" #
public 
record 
UserAuditDto 
( 
int 
AuditId 
, 
int 
UserId 
, 
string 

Action 
, 
string 

?
 
FieldChanged 
, 
string 

?
 
OldValue 
, 
string		 

?		
 
NewValue		 
,		 
int

 
?

 
	ChangedBy

	 
,

 
DateTime 
? 
	Timestamp 
) 
; Ò

ÖC:\Users\natha\OneDrive\Skrivebord\Kea-it-arkitektur\5. semester\TravelBuddy\src\Modules\TravelBuddy.Users\DTOs\RegisterRequestDto.cs
	namespace 	
TravelBuddy
 
. 
Users 
. 
DTOs  
{ 
public 

class 
RegisterRequestDto #
{ 
[ 	
Required	 
] 
public 
string 
Name 
{ 
get  
;  !
set" %
;% &
}' (
=) *
null+ /
!/ 0
;0 1
[		 	
Required			 
]		 
public

 
string

 
Email

 
{

 
get

 !
;

! "
set

# &
;

& '
}

( )
=

* +
null

, 0
!

0 1
;

1 2
[ 	
Required	 
] 
public 
string 
Password 
{  
get! $
;$ %
set& )
;) *
}+ ,
=- .
null/ 3
!3 4
;4 5
[ 	
Required	 
] 
public 
DateOnly 
	Birthdate !
{" #
get$ '
;' (
set) ,
;, -
}. /
} 
} ®
ãC:\Users\natha\OneDrive\Skrivebord\Kea-it-arkitektur\5. semester\TravelBuddy\src\Modules\TravelBuddy.Users\DTOs\PasswordChangeRequestDto.cs
	namespace 	
TravelBuddy
 
. 
Users 
. 
DTOs  
{ 
public 

class $
PasswordChangeRequestDto )
{ 
[ 	
Required	 
] 
public 
string 
OldPassword !
{" #
get$ '
;' (
set) ,
;, -
}. /
=0 1
null2 6
!6 7
;7 8
[		 	
Required			 
]		 
public

 
string

 
NewPassword

 !
{

" #
get

$ '
;

' (
set

) ,
;

, -
}

. /
=

0 1
null

2 6
!

6 7
;

7 8
} 
} ç
ÇC:\Users\natha\OneDrive\Skrivebord\Kea-it-arkitektur\5. semester\TravelBuddy\src\Modules\TravelBuddy.Users\DTOs\LoginRequestDto.cs
	namespace 	
TravelBuddy
 
. 
Users 
. 
DTOs  
{ 
public 

class 
LoginRequestDto  
{ 
[ 	
Required	 
] 
public 
string 
Email 
{ 
get !
;! "
set# &
;& '
}( )
=* +
null, 0
!0 1
;1 2
[		 	
Required			 
]		 
public

 
string

 
Password

 
{

  
get

! $
;

$ %
set

& )
;

) *
}

+ ,
=

- .
null

/ 3
!

3 4
;

4 5
} 
} ﬂ
ÇC:\Users\natha\OneDrive\Skrivebord\Kea-it-arkitektur\5. semester\TravelBuddy\src\Modules\TravelBuddy.Users\DTOs\AuthResponseDto.cs
	namespace 	
TravelBuddy
 
. 
Users 
. 
DTOs  
{ 
public 

record 
AuthResponseDto !
(! "
UserDto 
User 
, 
string 
Token 
) 
; 
} 